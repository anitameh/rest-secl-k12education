<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Reformat ProPublica Data into JSON</title>
    </head>
    <body>
        <!-- // <script src="scripts/underscore.js" type="text/javascript"></script> -->
        <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://d3js.org/queue.v1.min.js"></script>
        <script src="http://d3js.org/topojson.v1.min.js"></script>
        <script src="libs/FileSaver.js"></script>
        <div id="vis"></div>

        <script type="text/javascript">

        	// save reformatted data, one state per file
    		// d3.csv("data/original-data.csv", function(error, data) {
    		d3.csv("data/california200.csv", function(error, data) {
    			// console.log(data);
    			// data.forEach(function (d) {
    			// 	console.log(typeof(d.Neighbors));
    			// })
    			var nestData = d3.nest()
	    			.key(function(d) { return d.State; })
	    			.key(function(d) { return d.District_name; })
	    			.key(function(d) { return d.School_name; })
	    			.key(function(d) { return d.Neighbors; })
	    			.rollup(function(leaves) { return { "dis_mech_restraints": d3.sum(leaves, function(d) {return parseInt(d.idea_mech_restraints)+parseInt(d.section_504_mech_restraints)}),
	    												"dis_phys_restraints": d3.sum(leaves, function(d) {return parseInt(d.idea_phys_restraints)+parseInt(d.section_504_phys_restraints)}),
	    												"dis_seclusions": d3.sum(leaves, function(d) {return parseInt(d.idea_seclusion)+parseInt(d.section_504_seclusion)}),
	    												"no_dis_mech_restraints": d3.sum(leaves, function(d) {return parseInt(d.no_dis_mech_restraints)}),
	    												"no_dis_phys_restraints": d3.sum(leaves, function(d) {return parseInt(d.no_dis_physrestraints)}),
	    												"no_dis_seclusions": d3.sum(leaves, function(d) {return parseInt(d.no_dis_seclusion)}),
	    												"total_enroll": d3.sum(leaves, function(d) {return parseInt(d.total_enrollment)}) }; })
	    			.entries(data);
	
	    		for (var i=0; i < nestData.length; i++) {
	    			console.log(i);
	    			filename = nestData[i].key + ".json";
	    			console.log(filename)
	    			saveToFile(nestData[i], filename);
	    		}

    		})

			// saveToFile function
            var saveToFile = function(object, filename) {
		        var blob, blobText;

		        blobText = [JSON.stringify(object)];
		        blob = new Blob(blobText, {
		            type: "text/plain;charset=utf-8"
		        });
		        
		        saveAs(blob, filename);
		    };
        

            

        </script>

    </body>
</html>