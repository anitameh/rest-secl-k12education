<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Reformat ProPublica Data into JSON</title>
    </head>
    <body>
        <!-- // <script src="scripts/underscore.js" type="text/javascript"></script> -->
        <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://d3js.org/queue.v1.min.js"></script>
        <script src="http://d3js.org/topojson.v1.min.js"></script>
        <script src="libs/FileSaver.js"></script>
        <div id="vis"></div>

        <script type="text/javascript">


            // begin D3 code            
            d3.csv("data/original-data.csv", function(error, data) {

            	// initialize variables
            	var allData = {};
            	var newFormatData = [];
            	var states = [];
            	var myvals = {};

                // Create a dictionary {district_name: {school: {secl, mech, phys, enroll} } }
                newFormatData = [];
                newdata = data.slice(0,50);
                // newdata = data;
                
                newdata.forEach( function(d) {

                	var innerdictKeys = d3.keys(newFormatData);
                	var stateName = d.State;
                	var districtName = stateName + ", " + d.District_name;
               
                	if ((innerdictKeys).indexOf(districtName) < 0) {
                		newFormatData[districtName] = [];

                		var oneSchool = {};
	                	var variables = {};
	                	var schoolName = d.School_name;
	                		
	                	variables["dis_mech"] = parseInt(d.idea_mech_restraints)+parseInt(d.section_504_mech_restraints);
	                	variables["dis_phys"] = parseInt(d.idea_phys_restraints)+parseInt(d.section_504_phys_restraints);
	                	variables["dis_secl"] = parseInt(d.idea_seclusion)+parseInt(d.section_504_seclusion);
	                	variables["mech"] = parseInt(d.no_dis_mech_restraints);
	                	variables["phys"] = parseInt(d.no_dis_phys_restraints);
	                	variables["secl"] = parseInt(d.no_dis_seclusion);
	                	variables["total_enroll"] = parseInt(d.total_enrollment);
	                	oneSchool[schoolName] = variables;

	                	(newFormatData[districtName]).push(oneSchool); // add the first one
	                }
	                else {
	                	var oneSchool = {};
	                	var variables = {};
	                	var schoolName = d.School_name;
	                		
	                	variables["dis_mech"] = parseInt(d.idea_mech_restraints)+parseInt(d.section_504_mech_restraints);
	                	variables["dis_phys"] = parseInt(d.idea_phys_restraints)+parseInt(d.section_504_phys_restraints);
	                	variables["dis_secl"] = parseInt(d.idea_seclusion)+parseInt(d.section_504_seclusion);
	                	variables["mech"] = parseInt(d.no_dis_mech_restraints);
	                	variables["phys"] = parseInt(d.no_dis_phys_restraints);
	                	variables["secl"] = parseInt(d.no_dis_seclusion);
	                	variables["total_enroll"] = parseInt(d.total_enrollment);
	                	oneSchool[schoolName] = variables;

	                	// push the rest
		                (newFormatData[districtName]).push(oneSchool);
	                }
	                
                });
				console.log("writing to JSON...");
				// console.log(newFormatData);

	            saveToFile(newFormatData, "seclRestReformatData.json");

            });
            

            // saveToFile function
            var saveToFile = function(object, filename) {
		        var blob, blobText;
		        blobText = [JSON.stringify(object)];
		        blob = new Blob(blobText, {
		            type: "text/plain;charset=utf-8"
		        });
		        saveAs(blob, filename);
		    }

        </script>

    </body>
</html>